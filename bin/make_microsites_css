#!/usr/bin/perl -w

# Make microsite versions of PledgeBank's main CSS file

use FindBin;
chdir $FindBin::Bin;

my $outdir = '../web/microsites/autogen/';
mkdir $outdir;

my @sites = qw( interface catcomm o2 london livesimply );

my %has_people = (
    london => 1,
);

# 21004a - "Bank" in the heading, and nav. colour
my %purple_text = (
    #interface => '000000',
    catcomm => '000000',
    o2 => 'ffffff',
    london => '000000',
    livesimply => '000000',
);

# 522994 - Link colour,  and lots of borders
my %link_colour = (
    interface => '8f8f8f',
    catcomm => '31659c',
    o2 => '000066',
    london => '31659c',
);

# 7b52a5 - visited link colour
my %visited_colour = (
    interface => '666666',
    catcomm => '004488',
    o2 => '2385c2',
    london => '004488',
    livesimply => '0000aa',
);

# 9c7bbd - header background, "start" background
my %head_back = (
    catcomm => '99ccff',
    o2 => '000066',
    london => 'ee3438',
    livesimply => '000000',
);

# c6b5de - new form background, spreadword background
my %form_back = (
    interface => 'c6bcc2',
    catcomm => '99ccff',
    o2 => 'caddee',
    london => '9999ff',
    livesimply => '00aab5',
);

# f6e5ff - Pledge background, tips background, box hover
my %pledge_back = (
    interface => 'eeeeee',
    catcomm => 'd7ebff',
    o2 => 'caddee',
    london => 'ccccff',
    livesimply => 'cecfce',
);

# ff8429 - Sign box border
my %sign_border = (
    interface => 'ffbb88',
    livesimply => 'ffbb88',
);

# ffffcc - Sign box background
my %sign_back = (
    interface => 'ffffee',
    livesimply => 'ffffee',
);

open(MAINCSS, "../web/pb.2.css") or die "";

foreach my $site (@sites) {
    (my $func = $site) =~ s/^(\d)/c$1/;
    $func =~ s/-//;

    seek MAINCSS, 0, 0;
    open(NEWCSS, ">$outdir$site.css") or die "";
    print NEWCSS "/* AUTOMATICALLY GENERATED by make_microsites_css, do not edit */\n\n";
    my $selector = '';
    while (<MAINCSS>) {
        $selector = $1 if /^(.*) {/;
        s/pb\.2\.css/$site.css/;
        s/Top-level style sheet for PledgeBank.com/Custom style sheet for $site version of PledgeBank/;

        s/#21004a/#$purple_text{$func}/gi if $purple_text{$func};
        s/#522994/#$link_colour{$func}/gi if $link_colour{$func};
        s/#7b52a5/#$visited_colour{$func}/gi if $visited_colour{$func};
        s/#9c7bbd/#$head_back{$func}/gi if $head_back{$func};
        s/#c6b5de/#$form_back{$func}/gi if $form_back{$func};
        s/#f6e5ff/#$pledge_back{$func}/gi if $pledge_back{$func};
        s/#ff8429/#$sign_border{$func}/gi if $sign_border{$func};
        s/#ffffcc/#$sign_back{$func}/gi if $sign_back{$func};

        unless ($has_people{$func}) {
            s#background-image.*?/i/(box|comment|iwill|light|people|person|speechbubble).*?;##gi;
            s#padding-left:.*##gi if $selector =~ /^(#successfulpledges li|#success_more|#tellworld h2|#tellworld h3|#front #comments li|#startblurb a|#currentpledges li)$/;
            s#height: 54px##gi if $selector eq '#success_more';
            s#min-height:.*##gi if $selector eq '#localsignupeverypage';
            s#margin: 1em 55px 1em 0;#margin: 1em 0;#gi if $selector eq '#startblurb';
            s#padding: 15px 10px 10px#padding: 10px#gi if $selector eq '#startblurb';
        }

        my $changes = $func . '_changes';
        my $next;
        $next = $changes->($selector) if defined &$changes;
        next if $next && $next eq 'next';

        print NEWCSS $_;
    }
    my $extra = $func . '_extra';
    $extra->() if defined &$extra;
}

# Microsites

sub catcomm_changes {
    my $selector = shift;
    if ($selector eq '#col') {
        s#float: right;##gi;
        s#width: 33%;##gi;
    }
}

sub catcomm_extra {
    print NEWCSS <<EOF;
#currentpledges, #front #comments {
    float: left;
    clear: none;
    width: 59%;
}
#startblurb1, #extrablurb {
    float: right;
    width: 32%;
}
EOF
}

sub interface_changes {
    my $selector = shift;

    s/#ffffff/#888888/gi if $selector eq "h1 span#logo_pledge";
    s/#ffffff/#000000/gi if $selector =~ /^h1/ || $selector =~ /^#startblurb/;

    s/#000000/#222222/gi;  # text colour
    s/#21004a/#000000/gi;  # purple lettering, done after so above line doesn't get it

    s/background-color: #9c7bbd;/background-image: url(\/interface-body.gif);/i;
}

sub interface_extra {
    print NEWCSS "\nh2 { color: #000000; }\n";
}

sub london_extra {
    print NEWCSS "\n#sponsor { text-align: center; clear: both; }\n";
}

sub o2_changes {
    my $selector = shift;

    s/#000000/#2385c2/gi if $selector eq 'a:hover, a:active';

    s/top: 2.75em;/top: 48px;/ if ($selector eq "ul#nav");
    print NEWCSS "    font-weight: bold;\n" if (m/^}/ && $selector eq "ul#nav li");
    s/padding.*;/padding: 0;/ if ($selector eq 'h1');
    print NEWCSS <<EOF if (m/^}/ && $selector eq 'h1');
    background-image: url("/microsites/o2-stretch.jpg");
    height: 66px;
EOF

    s/font-family.*;/font-family: Verdana, Arial, sans-serif;/ if ($selector eq 'body');
    print NEWCSS <<EOF if (m/^}/ && $selector eq 'body');
    line-height: 1.4em;
    min-width: 770px;
    font-size: x-small; /* IE5 Win */
    voice-family: "\\"}\\""; 
    voice-family: inherit;
    font-size: small;
}
    
html>body { /* be nice to Opera */
    font-size: small;
EOF
}

sub o2_extra {
    print NEWCSS <<EOF;
h2, h3, h4, h5, h6 {
    margin:0.5em 0;
    color:#006;
}

h1 {
    font-size: 160%;
    font-weight:normal;
}
h2 {
    font-size:120%;
    font-bold:normal;
}
h3 {
    font-size:110%;
    font-weight:bold;
}
h4{
    font-size: 100%;
    font-weight:bold;
}
a{
    color:#006;
}
a:hover{
    text-decoration:none;
}

input, select, textarea {
    font-size:100%;
}
EOF
}

sub livesimply_changes {
    my $selector = shift;

    return 'next' if ($selector =~ m/ul#nav/ || $selector eq 'h1' || $selector eq '#nav_search' || $selector eq '#startblurb');

    $_ = "    font-family: verdana, arial, helvetica, sans-serif;\n" if m/font-family/;

    # Overall look
    s/margin: 1em auto 0;/margin: 1em 0 0 16em;/ if ($selector eq "#pbcontent");

    # Link colours
    s/#522994/#0000ff/gi if (!m/border|background/);  # link colour
    s/#522994/#000000/gi if (m/border/);  # border colour
    s/#522994/#cecfce/gi if (m/background/);  # startblurb boc

    s/#999999/#cccccc/g if ($selector eq '.greyed');

    # Headings
    print NEWCSS "    font-size: 120%;\n" if (m/^}/ && $selector eq 'h2');
    print NEWCSS "    font-size: 100%;\n" if (m/^}/ && $selector eq 'h3');

    # Body
    print NEWCSS "    font-size: 0.8em;\n" if (m/^}/ && $selector eq 'body');
}

sub livesimply_extra {
    print NEWCSS "\nh2 { color: #000000; }\n";
    print NEWCSS <<END;

#startblurb {
    padding: 10px;
    border: solid 1px #000000;
    background-color: #cecfce;
    color: #000000;
    -moz-border-radius: 2em;
    margin: 1em 0;
}
#nav_search {
    position: absolute;
    padding-left: 2em;
    text-align: left;
    font-size:83%;
    top: 4px; right: 4px;
}
#nav_search input {
    max-width: none;
}

h1 {
    margin: 0;
    padding: 0;
    text-align: left;
}

#pballfooter {
    margin: 0em 0 0 16em;
}
#pballheader{
    margin: 0em 0 0 19.5em;
}


/* From Partnerbasic.css */

#nav ul {
    margin: 0;
    padding: 0;
    list-style-type: none;
    background-color:#ffffff;
    color: black;
}

#nav {
    font-size: 90%;
    position: absolute;
    top: 181px;
    left: 4px; 
    clear: right;
}

/* From Partnerlevel2.css */

/* NAVIGATION */
/* Left nav */
.Line{
    border-bottom: 2px solid white;
}

ul#nav{
    margin: 0;
    padding: 0;
    list-style-type: none;
    width: 19em;
}

ul#nav li{
    list-style-type: none;
    vertical-align: text-top;
    text-align: left;
    text-transform: lowercase;
    padding-bottom: 2px;
}

ul#nav a{
    color: white;
    display: block;
    padding: 3px 3px 3px 8px;
    background-color: #9C9A9C;
    font-weight: bold;
    vertical-align: text-top;
    text-decoration: none;
}

ul#nav strong{
    display: block;
    padding: 3px 3px 3px 8px;
    color: white;
    vertical-align: text-top;
    background-color: #636563;
}

ul#nav a:hover{
    background-color: #636563;
    text-decoration: none;
    color: white;
}

ul#nav ul{
    margin: 0 0 0 22px;
    padding: 0;
}

/* ul#nav li{
    list-style-image: url(/images/sub/Disc_Bullet.gif);
}

ul#nav li.Plus{
    list-style-image: url(/images/sub/Plus_Bullet.gif);
}

ul#nav li.Arrow{
    list-style-image: url(/images/sub/Arrow_Bullet.gif);
} */

ul#nav ul a{
    font-weight: normal;
}

ul#nav ul a,  ul#nav ul strong{
    color: black;
    width: 100%;
    padding: 3px 3px 3px 0;
    background-color: white;
}

ul#nav ul a:hover{
    background-color: white;
    text-decoration: underline;
    color: black;
}

ul#nav ul ul{
    margin-left: 16px;
}

/* END NAVIGATION */

END

}
