#!/usr/bin/perl -w -I../../perllib
#
# test-run:
# Test harness for PledgeBank.  Makes sure we haven't broken the code.
# 
# Requires:
# * ../general/conf file set up for PledgeBank, and matching the below requirements
# * apache configured to serve ../web on OPTION_BASE_URL
# * a database with name ending "_testharness"; this script will drop and remake the
#   database, so make sure it is never used for anything important
# * email addresses (email_n below) configured to pipe to ./test-mailin with fast
#   local delivery
#
# Copyright (c) 2005 UK Citizens Online Democracy. All rights reserved.
# Email: francis@mysociety.org; WWW: http://www.mysociety.org/
#

my $rcsid = ''; $rcsid .= '$Id: test-run,v 1.30 2005-04-15 10:46:05 francis Exp $';

use strict;
require 5.8.0;

use Data::Dumper;
use Carp qw(verbose);
use Storable;
use FindBin;

use mySociety::Config;
mySociety::Config::set_file('../conf/general');
use mySociety::DBHandle qw(dbh);
use mySociety::WebTestHarness;

my $verbose = 2; # currently 3 levels: 0, 1 and 2
#DBI->trace(1);

our $base_url = mySociety::Config::get('BASE_URL');
our $admin_url = mySociety::Config::get('ADMIN_URL');
our $httpd_error_log = mySociety::Config::get('HTTPD_ERROR_LOG');
sub email_n { my $n = shift; return "pbharness+$n\@owl"; }
sub name_n { my $n = shift; return $n == 0 ? "Peter Setter" : "Siegfried Signer $n"; }

#############################################################################
# Main code

# Configure test harness class
print "Set up web test harness...\n" if $verbose > 0;
our $wth = new mySociety::WebTestHarness({db_option_prefix => 'PB_'});
$wth->log_watcher_setup($httpd_error_log);
$wth->database_drop_reload('../db/schema.sql');
$wth->email_setup({ eveld_bin => "$FindBin::Bin/../../services/EvEl/bin/eveld",
                    log_mailbox => "log_mailbox" });
our $b = $wth->browser_get_agent();

# Syntax check all .php files
print "Syntax check all PHP files...\n" if $verbose > 0;
$wth->php_check_syntax("../../pb/");
$wth->php_check_syntax("../../pb/templates/emails/", qr//);

# Check that we can detect PHP errors
print "Confirm we can detect errors...\n" if $verbose > 0;
$b->get($base_url . "/test.php?error=1" );
die "Unable to detect errors from PHP" if !$wth->log_watcher_get_errors();

# Run some pledges through life cycle
print "Making unconfirmed pledge...\n" if $verbose > 0;
do_unconfirmed_pledge();
print "Making private pledge and letting it expire...\n" if $verbose > 0;
do_private_failing_pledge();
print "Making public pledge and making it succeed...\n" if $verbose > 0;
do_public_succeeding_pledge();

# Check admin pages
print "Checking administration pages...\n" if $verbose > 0;
do_admin_pages();

# Check for any unhandled mails or errors
$wth->email_check_none_left();
$wth->log_watcher_check();
print "Everything completed successfully\n";

#############################################################################
# Functions to make and sign pledges, and so on

# sign_pledge WHO SHOW_SIGNATURE
# Adds a signer to a pledge, assumes browser is already pointing to pledge
# signup page.  Adds person number WHO.  SHOW_SIGNATURE is 1 for their
# signature to be public, undef for private.
sub sign_pledge {
    my ($who, $show_signature) = @_;

    $wth->browser_check_contents("Sign up now");
    $b->submit_form(form_name => 'pledge',
        fields => { 
            name => name_n($who), email => email_n($who), showname => $show_signature 
            },
        button => 'submit') or die "Failed to submit signing form";
    $wth->browser_check_contents("We've sent you an email to confirm your address");
    $wth->log_watcher_check();
}

# find_and_sign_pledge ACTION WHO SHOW_SIGNATURE
# Finds a public pledge from the front page use text ACTION, then calls
# sign_pledge.
sub find_and_sign_pledge {
    my ($action, $who, $show_signature) = @_;

    $b->get($base_url);
    $b->follow_link(text_regex => qr/$action/) or die "Pledge not appeared on front page";
    sign_pledge($who, $show_signature);
}

# confirm_signature ACTION WHO EXPECTED
# Looks for confirmation email to WHO with pledge action ACTION.  Follows link to
# confirm the signature.  EXPECTED indicates what result is expected:
#   'signed' - a successful signing
#   'reached' - a successful signing, which caused pledge to reach its target
#   'finished' - failed signing, because pledge has finished (closed, expired)
sub confirm_signature {
    my ($action, $who, $expected) = @_;
    $expected ||= "signed";
    
    # Click link in the confirmation email
    my $confirmation_email = $wth->email_get_containing(
        '%Subject: Signing up to \''.$action.'\''.
        '%To: '.email_n($who).
        '%to confirm your signature%');
    die "Confirmation link not found" if ($confirmation_email !~ m#^\s*($base_url.*$)#m);
#print "Confirm link is $1"; exit; # for testing confirmation links ;)
    $b->get($1);

    # Check there were no errors
    $wth->log_watcher_check();

    # Look for appropriate result in web page
    if ($expected eq 'signed' || $expected eq 'reached') {
        $wth->browser_check_contents("Thanks for signing");
        if ($expected eq 'reached') {
            $wth->browser_check_contents("Your signature has made this pledge reach its target!");
        }
    } elsif ($expected eq 'finished') {
        $wth->browser_check_contents("the pledge finished");
    } else {
        die "Unknown flag '$expected'";
    }
}

# create_pledge WHO PAGE1 PAGE2
# Creates a new pledge, setter is person number WHO.  PAGE1
# and PAGE2 contain parameters for each page of the sign-up form.
sub create_pledge {
    my ($who, $page1, $page2) = @_;
    $page1->{name} = name_n($who); 
    $page1->{email} = email_n($who);

    # Make new pledge
    $b->get($base_url);
    $b->follow_link(text_regex => qr/Start your own pledge/) or die "Start your own pledge link missing";
    $wth->browser_check_contents("New Pledge");
    $b->submit_form(form_name => 'pledge', fields => $page1,
        button => 'submit') or die "Failed to submit creating form stage 1";
    $wth->browser_check_contents("Step 2");
    $wth->log_watcher_check();
    $b->submit_form(form_name => 'pledge',
        fields => $page2,
        button => 'submit') or die "Failed to submit creating form stage 2";
    $wth->browser_check_contents("You must now click on the link within the email we've just sent you");

    # Add all to front page
    dbh()->do("delete from frontpage_pledges");
    dbh()->do("insert into frontpage_pledges (select id from pledges)");
    dbh()->commit();
}

# confirm_pledge WHO ACTION
sub confirm_pledge {
    my ($who, $action) = @_;
    # Confirm it
    $wth->log_watcher_check();
    my $confirmation_email = $wth->email_get_containing(
        '%To: '.email_n($who).'%to confirm that you%');
    die "Confirmation link not found\n" if ($confirmation_email !~ m#^($base_url.*$)#m);

    print "Pledge confirm URL $1\n" if $verbose > 1;
    $b->get($1);
    $wth->browser_check_contents("Thank you for confirming your pledge");
}

# do_not_confirm_pledge WHO ACTION
sub do_not_confirm_pledge {
    my ($who, $action) = @_;
    # Confirm it
    $wth->log_watcher_check();
    my $confirmation_email = $wth->email_get_containing(
        '%To: '.email_n($who).'%to confirm that you%');
    die "Confirmation link not found\n" if ($confirmation_email !~ m#^($base_url.*$)#m);
}

# Change the date that all parts of PledgeBank think is today.  Call with no
# parameters to reset it to the actual today.
sub set_pb_date {
    my $new_date = shift;
    if (defined($new_date)) {
        dbh()->do('delete from debugdate; insert into debugdate (override_today) values (?);', {}, $new_date);
    } else {
        dbh()->do('delete from debugdate;');
    }
    dbh()->commit();
}

# Call frequentupdate cron job
sub call_frequentupdate {
    system("php", "frequentupdate", $verbose > 1 ? qw("--verbose") : ()) 
        and die "Failed to call frequentupdate";
}

#############################################################################
sub do_unconfirmed_pledge {
    # Make the pledge
    set_pb_date('1980-12-01');
    my $pledge_action_unconfirmed = 'not confirm this pledge';
    my $pledge_ref = "neverconfirm";
    create_pledge(0, 
        { title => $pledge_action_unconfirmed, 
            target => '100', type => 'stubborn people', signup => 'will refuse ever to sign it',
            date => 'next thursday', ref => $pledge_ref,
        },
        { }
    );
    do_not_confirm_pledge(0, $pledge_action_unconfirmed);

    # Check not on front page
    $b->get($base_url);
    $wth->browser_check_no_contents($pledge_action_unconfirmed);
}

#############################################################################
sub do_private_failing_pledge {
    my $pledge_action_private = 'check private pledges are private';
    my $private_password = 'zx3uuhai';
    set_pb_date('1980-12-01');
    create_pledge(0, 
        { title => $pledge_action_private, 
            target => '10', date => 'Dec 31st', ref => 'privatepledge' 
        },
        { visibility => 'password', password => $private_password }
    );
    confirm_pledge(0, $pledge_action_private);
    $b->get($base_url);
    $wth->browser_check_no_contents($pledge_action_private);

    my $goto_pledge_page = sub {
        $b->get($base_url . "/privatepledge");
        $wth->browser_check_contents("Password Protected Pledge");
        $wth->browser_check_no_contents("Incorrect password!");
        $b->submit_form(form_name => 'pledge',
                fields => { pw => 'thisisnotthepassword' },
                button => 'submitpassword') or die "Failed to submit password form";
        $wth->browser_check_contents("Incorrect password!");
        $b->submit_form(form_name => 'pledge',
                fields => { pw => $private_password },
                button => 'submitpassword') or die "Failed to submit password form";
        $wth->browser_check_contents($pledge_action_private);
    };

    &$goto_pledge_page();
    $wth->browser_check_no_contents("This pledge is now closed");
    sign_pledge(1, 1);
    confirm_signature($pledge_action_private, 1);

    # Test what happens upon expiry
    # ... partially sign the pledge
    &$goto_pledge_page();
    sign_pledge(2, 1);
    # ... then expire it
    set_pb_date('1981-01-15');
    # ... make sure completing the partial signing fails
    confirm_signature($pledge_action_private, 2, 'finished');
    # Check failure emails
    call_frequentupdate();
    $wth->email_get_containing('%Subject: Sorry, your pledge failed%To: '.email_n(0).  '%');
    $wth->email_get_containing('%Subject: Pledge failed%To: '.email_n(1).  '%');

    # Make sure pledge says it is expired, and has no sign up box
    &$goto_pledge_page();
    $wth->browser_check_contents("This pledge is now closed");
    $wth->browser_check_no_contents("Sign up now");
}

#############################################################################
sub do_public_succeeding_pledge {
    # Make the pledge
    set_pb_date('1982-02-01');
    my $pledge_action_completion = 'make sure a pledge can be completed';
    my $pledge_ref = "automatedtest";
    create_pledge(0, 
        { title => $pledge_action_completion, 
            target => '3', type => 'automated lines of code', signup => 'do the same',
            date => 'tomorrow', ref => $pledge_ref,
        },
        { detail => "This pledge has just one purpose.  And that is as part of an automated test suite which ensures PledgeBank always works.  It is really quite good, in our humblest opinion.  It would save the planet, if only it was more comprehensive, and updated in a timely manner.\n\nAnd this bit is the start of a brand new shiny paragraph.  It should be formatted below on posters in the correct manner." }
    );
    confirm_pledge(0, $pledge_action_completion);

    # Mail pledge to friends
    $b->get($base_url . "/$pledge_ref");
    $b->follow_link(text_regex => qr/Email pledge/) or die "Email pledge to friends link not founm";
    $wth->browser_check_contents("Email this pledge");
    my $friend_message = "Hello you!";
    $b->submit_form(form_name => 'pledge',
        fields => { 
            fromname => name_n(0), fromemail => email_n(0), 
            frommessage => $friend_message,
            email1 =>  email_n(10),
            email2 =>  email_n(11),
            email3 =>  email_n(12),
            # deliberate gap
            email5 =>  email_n(13),
            },
        button => 'submit') or die "Failed to submit friend emailing form";
    $wth->browser_check_contents("Thanks very much for spreading the word");
    $wth->log_watcher_check();
    for (my $i = 10; $i <= 13; $i++) {
        my $content = $wth->email_get_containing('%To: '.email_n($i).  '%thought you would be interested%');
        $content =~ m#$base_url/$pledge_ref# or die "Failed to find pledge link in friend email";
        $content =~ m#$friend_message# or die "Failed to find message in friend email";
        $content =~ m## or die "Failed to find pledge link in friend email";
    }

    # Sign it a few times
    for (my $i = 1; $i <= 3; ++$i) {
        print "Signing the pledge $i...\n" if $verbose > 1;
        # Don't show name for one of the users
        my $show_signature = ($i == 2) ? undef : 1;
        find_and_sign_pledge($pledge_action_completion, $i, $show_signature);
    }
    for (my $i = 1; $i <= 3; ++$i) {
        print "Confirming signature $i...\n" if $verbose > 1;
        my $expect_target = ($i == 3);
        confirm_signature($pledge_action_completion, $i);
    }

    # Try to sign the pledge a second time as the same person
    find_and_sign_pledge($pledge_action_completion, 2, undef);
    $wth->email_get_containing('%To: '.email_n(2).
            '%you have already signed it%');

    # Partially sign pledge before completion state change...
    find_and_sign_pledge($pledge_action_completion, 4, 1);

    # Check pledge has completed
    call_frequentupdate();
    $b->get($base_url);
    $wth->browser_check_contents("Target met, pledge still open for 1 day");
    $b->follow_link(text_regex => qr/$pledge_action_completion/) or die "Pledge not appeared on front page";
    $wth->browser_check_contents("This pledge has been successful!");
    $wth->browser_check_contents("Plus 1 other who did not want to give their name");
    my $announce_link = undef;
    for (my $i = 0; $i <= 3; ++$i) {
        # Check email there or not there
        if ($i == 2) {
            $wth->browser_check_no_contents(name_n($i));
        } else {
            $wth->browser_check_contents(name_n($i));
        }
        # Check got success emails
        my $success_email = $wth->email_get_containing( '%To: '.email_n($i).'%Congratulations%');
        # For the creator success message, get announcement link
        if ($i == 0) {
            die "Success email link not found\n" if ($success_email !~ m#^\s*($base_url.*$)#m);
            $announce_link = $1;
            #print "Email success message link is $announce_link\n"; exit; # for testing success message links ;)
        }
    }
    $wth->log_watcher_check();

    # Send message using announcements page, from creator to signers.
    die "Failed to find announcements link" if !$announce_link;
    $b->get($announce_link);
    $wth->browser_check_contents("Send Announcement");
    $b->submit_form(form_name => 'pledge',
                fields => { message_body => "By merely partaking you have fulfilled your part in the pledge.  You rule!\n\nYours sincerely, \n\n" . name_n(0),
                            message_sms => "U rul. " . (split(m/ /,name_n(0)))[0]. " x"},
        button => 'submit') or die "Failed to submit email success form";
    $wth->browser_check_contents("Your message will now be sent to all the people who signed your pledge");
    $wth->log_watcher_check();
    call_frequentupdate();
    # Check they all arrived
    for (my $i = 1; $i <= 3; ++$i) {
        my $success_email = $wth->email_get_containing( '%To: '.email_n($i).'%By merely partaking%');
    }
    # Make sure no extra emails - in particular that late partial-signer hasn't got message
    call_frequentupdate();
    # TODO: Make this next line check that we only have the (unconfirmed) signup
    # message in the mail queue, and no other messages.
    # $wth->email_check_none_left();

    # ... now complete partial signature
    confirm_signature($pledge_action_completion, 4);
    # Check the late signer (number 4) also recieves the announcement message.
    call_frequentupdate();
    $wth->email_get_containing( '%To: '.email_n(4).'%By merely partaking%');

    # Check what happens when the pledge expires
    set_pb_date('1982-02-03');
    # Front page should no longer have pledge on it
    $b->get($base_url);
    $wth->browser_check_no_contents($pledge_action_completion);
    # Pledge should say the right things
    $b->get($base_url . "/$pledge_ref");
    $wth->browser_check_contents("This pledge is now closed");
    $wth->browser_check_no_contents("Sign up now");
    $wth->browser_check_contents("This pledge has been successful!");
    $wth->browser_check_contents(name_n(4));
    $wth->browser_check_no_contents(name_n(5));
}

#############################################################################
sub do_admin_pages {
    $b->get($admin_url);
    $b->follow_link(text_regex => qr/Pledges and Signers/) or die "Pledges and Signers link missing";
    $wth->browser_check_contents("automatedtest");
    $wth->browser_check_contents("privatepledge");
}

